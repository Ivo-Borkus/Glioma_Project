---
title: "Current status check"
author: "Ivo Borkus"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = T, message = FALSE, warning = FALSE,
    fig.align = "center", fig.width = 10, fig.height = 10
)
knitr::render_markdown()
```

```{css, echo = F}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}

pre {
  max-height: 300px;
  overflow-y: auto;
}
```
```{r loading libraries, include = FALSE}
library(Seurat)
library(dplyr)
library(ggplot2)
library(here)
library(tidyr)
library(patchwork)
library(UCell)
library(qs2)
library(future)
plan(sequential)
options(future.globals.maxSize = 100000 * 1024^2)
# source(here("Brain-Met_V2/functions.R"))
source(here("Glioma_Project/Scripting/utils.R"))
source(here("Glioma_Project/Scripting/functions.R"))
# source(here("External_data/Fastq_processing/metadata_functions.R"))
```

# Setting paths and names

Here we set the variables necessary to run my custom scripts. The rest of the script therefore should not be tweaked. 

However, as there is an interpretation stage, all code after Results is custom for each object.
```{r}
exc_path <- here("Glioma_Project/01_data/Excel")
rmd_path <- here("Glioma_Project/02_knits/figs")
obj_path <- here("Glioma_Project/01_data")
fig_path <- here("Glioma_Project/04_figs")

object_name <- "Processed"
reduction_name <- "Inhouse_Harmony"
Processed_name <- "Harmony"
sample_col <- "sample_name"
batch_cols <- c(
    "tumour_full", "tumour_abbreviated", "grade", "Cell_Type", "Cell_Subtype", "sample_name", "IDH_status",
    "FACS_sorting", "tier_correct", "cell_het_paper_id", "storage_condition", "prior_treatment", "gender", "Tumour_Margin",
    "Primary_or_Recurrent", "Previous_Surgery", "Radiotherapy", "Chemotherapy", "MGMT_Methylation"
)
continous_cols <- c("nCount_RNA", "nFeature_RNA", "percent.mt", "age_at_surgery_correct", "nuclear_fraction")
```

# To Do
RE: pro/anti-inf signatures, I think it would make sense to compute the overall 
signatures only on myeloid cells to compare the three diseases but you could also stratify then into
 microglia, macrophages and monocytes (DCs could be included but I don't think this signatures really apply to them).
Then if you want to add significance you could either average the scores by patient (only myeloid) 
or pseudobulk only myeloid per patient and score at a pseudobulk level (I would prefer this approach), 
then you can apply a max rank sum test on the score per patient between groups (disease/IDH-status...).
```{r pro anti sign, eval = T}
# Four principal immunomodulatory programs
# https://www.nature.com/articles/s41586-025-08633-8
# Programs, origins and immunomodulatory functions of myeloid cells in glioma
# Cel reports medicine Juan nieto:
# Tumor heterogeneity and tumor-microglia interactions in primary and recurrent IDH1-mutant gliomass
BD <- c("LYZ", "EREG", "S100A8", "S100A9", "ITGAL", "ITGA4", "PTPRC", "FCGR3A", "CEBPD", "EGR2", "IRF4", "RUNX1", "STAT3", "CCL22", "CXCL2", "CD14", "S100A4", "S100A6", "FCN1", "VCAN", "CD36", "LGALS3", "SELENOP", "SLC40A1", "CXCR4")
MG <- c("P2RY12", "CX3CR1", "CSF1R", "AXL", "TMEM119", "CD84", "CSF3R", "ELMO1", "MEF2A", "BIN1", "SCIN", "FCGBP", "OLFML3", "NAV3", "SALL1", "SIGLEC8", "SLC1A3", "ITGAM", "TREM2", "PROS1", "SPARC", "PLCL1", "VIM", "APOE", "SMAD3", "P2RX7", "LYVE1", "MS4A7", "FOLR2", "HLA-DRA", "TIMD4", "ADGRG1", "TGFBI", "CD74")
gene_list <- list(
    "Systemic inflammatory" = c("IL1B", "IL1A", "CCL2", "TNF", "OSM", "CXCL8", "CD83", "CCL4", "CCL3", "CD74"),
    "Microglial inflammatory" = c("CXCR4", "CXCL12", "CCL3", "CCL5", "CX3CR1", "RHOB", "JUN", "KLF2", "EGR1", "PDK4", "P2RY13", "ICAM1", "RELB", "TNFAIP3"),
    "Anti_Inflam" = c("MRC1", "MSR1", "CD163", "LYVE1", " COLEC12", "STAB1", "NRP1", "RNASE1", "CTSB", "VSIG4", "SELENOP"),
    "Resident" = MG,
    "Infiltrating" = BD
)
```


```{r}
# Doing some comparisons:
reduction_name <- "M_M"
obj <- qs_read(here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
obj$`Infiltration-Residence` <- (scales::rescale(obj$Infiltrating_UCell) - scales::rescale(obj$Resident_UCell)) # so they are scaled
obj$Ann_lvl_2 %>% table()
pseudo_seurat <- AggregateExpression(obj, assays = "RNA", return.seurat = T, group.by = c("sample_name"))
pseudo_seurat <- NormalizeData(pseudo_seurat)
df_list <- lapply(names(gene_list), \(.){
    data.frame("source" = ., "target" = gene_list[[.]], "mor" = 1)
})
net <- do.call(rbind, df_list)
mat <- pseudo_seurat[["RNA"]]$data
res_mlm <- decoupleR::run_mlm(
    mat = mat,
    network = net,
    .source = "source",
    .target = "target",
    center = FALSE
)
meta_df <- obj@meta.data
meta_df[, c(9:30, 38:40)] %>% distinct() -> new_df
new_df %>% tibble::remove_rownames() -> distinct_meta
check <- lapply(colnames(distinct_meta), \(c){
    if (class(distinct_meta[[c]]) == "list") {
        distinct_meta[[c]] <- as.character(distinct_meta[[c]])
    } else {
        distinct_meta[[c]]
    }
}) %>% as.data.frame()
colnames(check) <- colnames(distinct_meta)
check$sample_name <- gsub("_", "-", x = check$sample_name)
res_mlm <- res_mlm |> left_join(check, by = join_by(condition == sample_name))

# ggpubr::compare_means(score~ IDH_status,res_mlm, group.by = 'source')
# ggpubr::compare_means(score~ tumour_full,res_mlm,group.by = 'source')

p_overview_IDH <- res_mlm %>% ggplot(mapping = aes(x = IDH_status, y = score)) +
    geom_boxplot() +
    facet_wrap(~source, nrow = 1, scales = "free_y") +
    ggpubr::stat_compare_means(comparisons = list(c("wild_type", "mutant")), label = "p.signif", method = "wilcox.test") +
    theme_bw() +
    x_axis_theme
p_overview_tumour <- res_mlm %>% ggplot(mapping = aes(x = tumour_abbreviated, y = score)) +
    geom_boxplot() +
    facet_wrap(~source, nrow = 1, scales = "free_y") +
    ggpubr::stat_compare_means(comparisons = list(c("ASTR", "GBM"), c("ASTR", "ODG"), c("GBM", "ODG")), label = "p.signif", method = "wilcox.test") +
    theme_bw() +
    x_axis_theme
pdf(here("Glioma_Project/04_figs/02_12-02-2026_significance_testing.pdf"), width = 9, height = 5)
p_overview_IDH
p_overview_tumour
dev.off()
# ggpubr documentation shows the annotation and significance.
# ns: p > 0.05
# *: p <= 0.05
# **: p <= 0.01
# ***: p <= 0.001
# ****: p <= 0.0001
```

```{r computing ratios}
# seurat_obj_path <- ifelse(!is.null(sub_dir), here(obj_path, sub_dir, paste0(Processed_name, ".qs2")), here(obj_path, paste0(Processed_name, ".qs2")))
# seurat_obj <- qs_read(seurat_obj_path)
# seurat_obj_clean <- subset(seurat_obj, subset = Ann_lvl_2 %in% c('Bad-quality','Hb+'), invert = TRUE)
# seurat_obj_clean_P <- seurat_processing_manual(seurat_obj_clean, reduction_name = 'clean') # sample_name, 2000, 30, 3
# qs_save(seurat_obj_clean_P,here('Glioma_Project/03_seurat_objects/Processed_Clean.qs2'))
seurat_obj_clean_P <- qs_read(here("Glioma_Project/03_seurat_objects/Processed_Clean.qs2"))
meta_df <- seurat_obj_clean_P@meta.data
meta_df[, c(9:30, 38:40)] %>% distinct() -> new_df
new_df %>% tibble::remove_rownames() -> distinct_meta
check <- lapply(colnames(distinct_meta), \(c){
    if (class(distinct_meta[[c]]) == "list") {
        distinct_meta[[c]] <- as.character(distinct_meta[[c]])
    } else {
        distinct_meta[[c]]
    }
}) %>% as.data.frame()
colnames(check) <- colnames(distinct_meta)
check$sample_name <- gsub("_", "-", x = check$sample_name)
metadf <- seurat_obj_clean_P@meta.data %>%
    group_by(Ann_lvl_2, Ann_lvl_1H, sample_name) %>%
    summarise(count = n())
# Creating the totals.
total_df <- metadf %>%
    group_by(sample_name) %>%
    summarise(sample_count = sum(count)) %>%
    as.data.frame()
total_df <- metadf %>%
    filter(Ann_lvl_1H %in% c("T-CD8+", "T-CD4+", "T-other", "NK", "T-Prolif")) %>%
    group_by(sample_name) %>%
    summarise(Tcellcount = sum(count)) %>%
    as.data.frame() %>%
    right_join(total_df, by = "sample_name")
total_df <- metadf %>%
    filter(!Ann_lvl_1H %in% c("T-CD8+", "T-CD4+", "T-other", "NK", "T-Prolif")) %>%
    group_by(sample_name) %>%
    summarise(Mcellcount = sum(count)) %>%
    as.data.frame() %>%
    right_join(total_df, by = "sample_name")


total_df <- metadf %>%
    filter(Ann_lvl_1H %in% c("DCs")) %>%
    group_by(sample_name) %>%
    summarise(DC_count = sum(count)) %>%
    as.data.frame() %>%
    right_join(total_df, by = "sample_name")
total_df <- metadf %>%
    filter(Ann_lvl_1H %in% c("Microglia")) %>%
    group_by(sample_name) %>%
    summarise(Microglia = sum(count)) %>%
    as.data.frame() %>%
    right_join(total_df, by = "sample_name")
total_df <- metadf %>%
    filter(Ann_lvl_1H %in% c("Macrophage", "Monocyte")) %>%
    group_by(sample_name) %>%
    summarise(Macro_mono = sum(count)) %>%
    as.data.frame() %>%
    right_join(total_df, by = "sample_name")
total_df[is.na(total_df)] <- 0
total_df[["T_cells_Myeloid"]] <- (total_df[["Tcellcount"]] / total_df[["Mcellcount"]])
total_df[["T_cells_Microglia"]] <- (total_df[["Tcellcount"]] / total_df[["Microglia"]])
total_df[["T_cells_Macro_Mono"]] <- (total_df[["Tcellcount"]] / total_df[["Macro_mono"]])
total_df[["T_cells_DC"]] <- (total_df[["Tcellcount"]] / total_df[["DC_count"]])
total_df[["Microglia_Macro_mono"]] <- (total_df[["Microglia"]] / total_df[["Macro_mono"]])
total_df[["DC_count_Microglia"]] <- (total_df[["DC_count"]] / total_df[["Microglia"]])
total_df[["Tcell_prop"]] <- (total_df[["Tcellcount"]] / total_df[["sample_count"]])
total_df[["Mcell_prop"]] <- (total_df[["Mcellcount"]] / total_df[["sample_count"]])
total_df[["DC_prop"]] <- (total_df[["DC_count"]] / total_df[["sample_count"]])
total_df[["Microglia_prop"]] <- (total_df[["Microglia"]] / total_df[["sample_count"]])
total_df[["Macro_mono_prop"]] <- (total_df[["Macro_mono"]] / total_df[["sample_count"]])
total_df$sample_name <- gsub("_", "-", x = total_df$sample_name)
```

```{r}
res_mlm <- res_mlm |> left_join(check, by = join_by(condition == sample_name))
res_mlm_final <- res_mlm |> left_join(total_df, by = join_by(condition == sample_name))
p <- lapply(colnames(total_df)[-1], \(col){
    plot <- res_mlm_final %>% ggpubr::ggscatter(
        x = as.character(col), y = "score",
        add = "reg.line",
        add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line    conf.int = TRUE, # Add confidence interval
        cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
        conf.int = TRUE, # Add confidence interval
        cor.coeff.args = list(method = "pearson", label.sep = "\n")
    ) + x_axis_theme
    plot <- ggpubr::facet(plot,
        facet.by = c("source", "tumour_abbreviated"), scales = "free", short.panel.labs = T, # Allow long labels in panels
        panel.labs.background = list(fill = "grey", color = "grey"), panel.labs.font = list(size = 13, color = "black")
    )
    return(plot)
})
pdf(here("Glioma_Project/04_figs/02_significance_ratios_SUBtype.pdf"), width = 8, height = 15)
p
dev.off()


p2 <- lapply(colnames(total_df)[-1], \(col){
    plot <- res_mlm_final %>% ggpubr::ggscatter(
        x = as.character(col), y = "score",
        add = "reg.line",
        add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line    conf.int = TRUE, # Add confidence interval
        cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
        conf.int = TRUE, # Add confidence interval
        cor.coeff.args = list(method = "pearson")
    ) + x_axis_theme
    plot <- ggpubr::facet(plot,
        facet.by = c("source", "IDH_status"), scales = "free", short.panel.labs = TRUE, # Allow long labels in panels
        panel.labs.background = list(fill = "grey", color = "grey"), panel.labs.font = list(size = 13, color = "black")
    )
    return(plot)
})
pdf(here("Glioma_Project/04_figs/02_significance_ratios_IDH.pdf"), width = 8, height = 12)
p2
dev.off()
# col <- colnames(total_df[2])
# plot <- res_mlm_final %>% ggplot(mapping = aes(x =!!sym(col), y = score))+
#     geom_point()  +
#     facet_grid(tumour_abbreviated~source, scales = 'free_y')+
#     theme_bw() + x_axis_theme
```


```{r}
# testing
colnames(res_mlm_final)
plot <- res_mlm_final %>% ggpubr::ggscatter(
    x = as.character("DC_count_Microglia"), y = "score",
    add = "reg.line",
    add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line    conf.int = TRUE, # Add confidence interval
    cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
    conf.int = TRUE, # Add confidence interval
    cor.coeff.args = list(method = "pearson", label.x = max(res_mlm_final[[as.character("DC_count_Microglia")]]) / 4, label.sep = "\n")
) + x_axis_theme
plot
c("source", "IDH_status")
plot <- ggpubr::facet(plot,
    facet.by = c("source", "IDH_status"), scales = "free", short.panel.labs = TRUE, # Allow long labels in panels
    panel.labs.background = list(fill = "skyblue", color = "skyblue")
)
plot
```

```{r computing inflamm scores}
reduction_name <- "M_M"
seurat_obj <- qs_read(here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
pseudo_seurat <- AggregateExpression(seurat_obj_subset, assays = "RNA", return.seurat = T, group.by = c("sample_name", "Ann_lvl_1H"))
df_list <- lapply(names(gene_list), \(.){
    data.frame("source" = ., "target" = gene_list[[.]], "mor" = 1)
})
net <- do.call(rbind, df_list)
mat <- pseudo_seurat[["RNA"]]$counts
net$target %>% unique()
net$target
res_mlm <- decoupleR::run_mlm(
    mat = mat,
    network = net,
    .source = "source",
    .target = "target",
    center = FALSE
)
res_mlm
mat_mlm <- res_mlm %>%
    # tidyr::separate(col = condition, sep = "_", into = c("sample_name", "Celltype"), remove = FALSE) %>%
    decoupleR::pivot_wider_profile(
        id_cols = source,
        names_from = condition,
        values_from = score
    )
mat_mlm
maxs <- apply(mat_mlm, 2, max)
mins <- apply(mat_mlm, 2, min)
scaled_m <- scale(mat_mlm, center = mins, scale = maxs - mins) # scaling the values for heatmap
colors <- rev(RColorBrewer::brewer.pal(n = 11, name = "RdBu"))
colors.use <- grDevices::colorRampPalette(colors = colors)(100)
# Heatmap
pheatmap::pheatmap(
    mat = t(scaled_m[, 1:30]),
    color = colors.use,
    border_color = "white",
    cluster_rows = FALSE,
    cluster_cols = FALSE,
    cellwidth = 20,
    cellheight = 20,
    treeheight_row = 0,
    treeheight_col = 0
)

plot_df <- res_mlm %>% filter(p_value < 0.05) %>% # Filter necessary?
    tidyr::separate(col = condition, sep = "_", into = c("sample_name", "Celltype"), remove = FALSE)

plot_df %>% ggplot(mapping = aes(x = Celltype, y = score)) +
    geom_boxplot() +
    facet_wrap(~source) +
    theme_bw() +
    x_axis_theme
ggsave(here("Glioma_Project/04_figs/DecouplR_results.pdf"))
```


RE: Milo, would make more sense to split Lymphoid and Myeloid cells and maybe,
just for the plots, split the myeloids into microglia, macrophages, monocytes and DCs
and the lymphoid into CD4, CD8, NK and B cells if any? 
and I would definitely remove the bad quality and the Hb+ cells as they will only add more noise (from all of the analyses actually).
Plus let's try to figure out what this mixed population is (doublets? proliferative?),
otherwise I would also remove them as it is not providing any helpful information. 
You can also run scCODA to validate these findings both for the diseases and the IDH mut/wt.


### plan

DecoupleR:
1. Determine signature of M_M populations by a select portion. (Microglia Inflammatory/True_residence/True_infiltrating/Anti_Inflammatory)
2. Order samples by their environment like scores.
3. Determine by the use of a signature if a cell is truly resident like, or truly Infiltrating
    1. Do the same for the inflammation and Anti_Inflammatory
4. Include T-reg information so show the order of samples by their environment in the myleoid populatin and then show T-cell comp.
5. Perform significance testing by extracting only meaningfull signficance.
6. add other information to see whethere this might explain very well the environment.



# Determining signatures in populations by a threshold

```{r trying some signatures on UMAP}
reduction_name <- "M_M"
obj <- qs_read(here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
Ucell_cols <- colnames(obj@meta.data)[obj@meta.data %>%
    colnames() %>%
    grep("UCell", .)]
# obj$`Infiltration-Residence` <- (scales::rescale(obj$Infiltrating_UCell)  - scales::rescale(obj$Resident_UCell)) # so they are scaled
obj$`True_Infiltration` <- (scales::rescale(obj$Infiltrating_UCell) - scales::rescale(obj$Resident_UCell)) # so they are scaled
obj$`True_Residence` <- (scales::rescale(obj$Resident_UCell) - scales::rescale(obj$Infiltrating_UCell)) # so they are scaled
obj$`True_Inflammation` <- (scales::rescale(obj$`Microglial inflammatory_UCell`) - scales::rescale(obj$Anti_Inflam_UCell)) # so they are scaled
obj$`True_Anti_inflammation` <- (scales::rescale(obj$Anti_Inflam_UCell) - scales::rescale(obj$`Microglial inflammatory_UCell`)) # so they are scaled
new_cols <- c("True_Infiltration", "True_Residence", "True_Inflammation", "True_Anti_inflammation")
old_cols <- c("Systemic inflammatory_UCell", "Microglial inflammatory_UCell", "Anti_Inflam_UCell", "Resident_UCell", "Infiltrating_UCell")

cutoff_infl_p <- median(obj$True_Inflammation) + 0.5 * sd(obj$True_Inflammation)
cutoff_infl_n <- median(obj$True_Inflammation) - 0.5 * sd(obj$True_Inflammation)
cutoff_infi_p <- median(obj$True_Infiltration) + 0.5 * sd(obj$True_Infiltration)
cutoff_infi_n <- median(obj$True_Infiltration) - 0.5 * sd(obj$True_Infiltration)
obj@meta.data <- obj@meta.data %>%
    mutate(Infiltration_cells = case_when(
        True_Infiltration > cutoff_infl_p ~ "Infiltrating",
        True_Infiltration < cutoff_infl_n ~ "Resident",
        .default = "Average"
    )) %>%
    mutate(Inflammatory_cells = case_when(
        True_Inflammation < cutoff_infl_n ~ "Anti_inflammatory",
        True_Inflammation > cutoff_infl_p ~ "Inflammatory",
        .default = "Average"
    ))
obj$Inflammatory_cells <- factor(obj$Inflammatory_cells, levels = c("Anti_inflammatory", "Average", "Inflammatory"))
obj$Infiltration_cells <- factor(obj$Infiltration_cells, levels = c("Resident", "Average", "Infiltrating"))
qs_save(obj, here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
```

```{r determining orderings }
reduction_name <- "Clean"
obj <- qs_read(here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
sample_count_df <- obj@meta.data %>%
    group_by(sample_name) %>%
    summarise(sample_count = n())
reduction_name <- "M_M"
obj <- qs_read(here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
col <- c("Inflammatory_cells" = "Inflammatory", "Infiltration_cells" = "Infiltrating", "Ann_lvl_1H" = "Microglia")
order_list <- lapply(names(col), \(i){
    count_table <- obj@meta.data %>%
        group_by(!!sym(i), sample_name) %>%
        summarise(count = n())
    freq_table <- count_table %>%
        left_join(sample_count_df) %>%
        group_by(sample_name) %>%
        mutate(prop = count / sample_count * 100) %>%
        ungroup() %>%
        complete(sample_name, !!sym(i), fill = list(prop = 0)) %>%
        ungroup()
    order <- freq_table %>%
        filter(!!sym(i) == col[i]) %>%
        arrange(desc(prop)) %>% # highest first
        pull(sample_name)
})
names(order_list) <- col
```

```{r plotting}
# Objects
# reduction_name <- 'M_M'
# reduction_name <- 'M'
# reduction_name <- 'T'
# reduction_name <- 'Clean'
# obj <- qs_read(here(paste0('Glioma_Project/03_seurat_objects/Processed_',reduction_name,'.qs2')))
c16 <- c("dodgerblue2", "#E31A1C", "green4", "#6A3D9A", "#FF7F00", "black", "gold1", "skyblue2", "palegreen2", "#FDBF6F", "gray70", "maroon", "orchid1", "darkturquoise", "darkorange4", "brown")
c25 <- c("dodgerblue2", "#E31A1C", "green4", "#6A3D9A", "#FF7F00", "black", "gold1", "skyblue2", "#FB9A99", "palegreen2", "#CAB2D6", "#FDBF6F", "gray70", "khaki2", "maroon", "orchid1", "deeppink1", "blue1", "steelblue4", "darkturquoise", "green1", "yellow4", "yellow3", "darkorange4", "brown")
reduction_name <- "Clean"
obj <- qs_read(here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
variable_col <- "Ann_lvl_2"
tregs_order <- obj@meta.data %>%
    group_by(sample_name, !!sym(variable_col)) %>%
    select(!!sym(variable_col), sample_name) %>%
    summarise(count = n()) %>%
    ungroup() %>%
    left_join(sample_count_df) %>%
    group_by(sample_name) %>%
    mutate(prop = count / sample_count * 100) %>%
    ungroup() %>%
    complete(sample_name, Ann_lvl_2, fill = list(prop = 0)) %>%
    filter(Ann_lvl_2 == "Tregs") %>%
    arrange(desc(prop)) %>%
    pull(sample_name)
col <- c("Inflammatory_cells" = "Inflammatory", "Infiltration_cells" = "Infiltrating", "Ann_lvl_1H" = "Microglia", "Ann_lvl_2" = "Tregs")
order_list[[col["Ann_lvl_2"]]] <- tregs_order
```

```{r}
reduction_name <- "Clean"
obj <- qs_read(here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
variable_col <- "Ann_lvl_1H"
lapply(names(col), \(i){
    freq_table <- obj@meta.data %>%
        group_by(!!sym(variable_col), sample_name) %>%
        summarise(count = n()) %>%
        # left_join(sample_count_df) %>%
        group_by(sample_name) %>%
        mutate(prop = count / sum(count) * 100) %>%
        ungroup() %>%
        complete(sample_name, !!sym(variable_col), fill = list(prop = 0)) %>%
        ungroup()
    freq_table$sample_name <- factor(freq_table$sample_name, levels = order_list[[col[i]]])
    freq_table$variable <- freq_table[[variable_col]]
    p1 <- freq_table %>%
        ggplot(aes(fill = variable, y = prop, x = sample_name)) +
        geom_bar(position = "stack", stat = "identity") +
        theme_classic() +
        # scale_fill_brewer(palette = 'Set2')+
        scale_fill_manual(values = c25[1:length(unique(freq_table$variable))]) +
        RotatedAxis() +
        scale_y_continuous(expand = c(0, 0)) +
        labs(x = "Patient", y = "Percentage", fill = "Cell Type", title = col[i]) +
        # facet_grid(. ~ variable, scales = "free", space = "free") + # , strip = strip) +
        theme(plot.margin = unit(c(1, 1, 1, 2), "cm")) +
        geom_hline(yintercept = c(25, 50, 75), colour = "red", linetype = "dashed")
    return(p1)
}) |> wrap_plots() + plot_layout(guides = "collect", axes = "collect")
ggsave(here(fig_path, paste0(reduction_name, "_", variable_col, "_composition_test.pdf")), width = 30, height = 15)
```

```{r plotting the results}
pdf(here("Glioma_Project/04_figs/Test_signature_2.pdf"), width = 15, height = 10)
plot_list <- lapply(old_cols, \(i){
    p <- ggplot(obj@meta.data, mapping = aes(x = Ann_lvl_2, y = !!sym(i), fill = Ann_lvl_1H)) +
        ggrastr::rasterise(geom_violin()) +
        ggrastr::rasterise(geom_boxplot(width = 0.1, alpha = 0.5)) +
        x_axis_theme +
        ggtitle(i)
})
plot_list2 <- lapply(new_cols, \(i){
    p <- ggplot(obj@meta.data, mapping = aes(x = Ann_lvl_2, y = !!sym(i), fill = Ann_lvl_1H)) +
        ggrastr::rasterise(geom_violin()) +
        ggrastr::rasterise(geom_boxplot(width = 0.1, alpha = 0.5)) +
        x_axis_theme +
        ggtitle(i)
})
cols_3 <- c("log_nCount_RNA", "log_nFeature_RNA", "percent_mt")
plot_list_3 <- lapply(cols_3, \(i){
    p <- ggplot(obj@meta.data, mapping = aes(x = Ann_lvl_2, y = !!sym(i), fill = Ann_lvl_1H)) +
        ggrastr::rasterise(geom_violin()) +
        ggrastr::rasterise(geom_boxplot(width = 0.1, alpha = 0.5)) +
        x_axis_theme +
        ggtitle(i)
})

plot_list |> wrap_plots(ncol = 2) + plot_layout(guides = "collect", axes = "collect")
plot_list2 |> wrap_plots(ncol = 2) + plot_layout(guides = "collect", axes = "collect")
plot_list_3 |> wrap_plots(ncol = 2) + plot_layout(guides = "collect", axes = "collect")
## Inflammatory Old sig
lapply(old_cols, \(i){
    p <- ggplot(obj@meta.data, mapping = aes(x = Inflammatory_cells, y = !!sym(i))) +
        ggrastr::rasterise(geom_violin()) +
        ggrastr::rasterise(geom_boxplot(width = 0.1, alpha = 0.5)) +
        x_axis_theme +
        ggtitle(i)
}) |> wrap_plots(ncol = 2) + plot_layout(guides = "collect", axes = "collect")
## Inflammatory new sig
lapply(new_cols, \(i){
    p <- ggplot(obj@meta.data, mapping = aes(x = Inflammatory_cells, y = !!sym(i))) +
        ggrastr::rasterise(geom_violin()) +
        ggrastr::rasterise(geom_boxplot(width = 0.1, alpha = 0.5)) +
        x_axis_theme +
        ggtitle(i)
}) |> wrap_plots(ncol = 2) + plot_layout(guides = "collect", axes = "collect")
## Infiltratin Old sig
lapply(old_cols, \(i){
    p <- ggplot(obj@meta.data, mapping = aes(x = Infiltration_cells, y = !!sym(i))) +
        ggrastr::rasterise(geom_violin()) +
        ggrastr::rasterise(geom_boxplot(width = 0.1, alpha = 0.5)) +
        x_axis_theme +
        ggtitle(i)
}) |> wrap_plots(ncol = 2) + plot_layout(guides = "collect", axes = "collect") + wrap_table(table(obj$Infiltration_cells, obj$Inflammatory_cells) %>% as.data.frame.matrix() %>% gt::gt(rownames_to_stub = TRUE))
## Infiltratin new sig
lapply(new_cols, \(i){
    p <- ggplot(obj@meta.data, mapping = aes(x = Infiltration_cells, y = !!sym(i))) +
        ggrastr::rasterise(geom_violin()) +
        ggrastr::rasterise(geom_boxplot(width = 0.1, alpha = 0.5)) +
        x_axis_theme +
        ggtitle(i)
}) |> wrap_plots(ncol = 2) + plot_layout(guides = "collect", axes = "collect")
dev.off()
```


```{r}
reduction_name <- "M_M"
obj <- qs_read(here(paste0("Glioma_Project/03_seurat_objects/Processed_", reduction_name, ".qs2")))
pseudo_seurat <- AggregateExpression(obj, assays = "RNA", return.seurat = T, group.by = c("sample_name"))
pseudo_seurat <- NormalizeData(pseudo_seurat)
mat <- pseudo_seurat[["RNA"]]$data


df <- data.frame("source" = "True_Infiltration", "target" = gene_list[["Infiltrating"]], "mor" = 1)
df <- rbind(df, data.frame("source" = "True_Infiltration", "target" = gene_list[["Resident"]], "mor" = -1))
df <- rbind(df, data.frame("source" = "True_Inflammation", "target" = gene_list[["Microglial inflammatory"]], "mor" = 1))
net <- rbind(df, data.frame("source" = "True_Inflammation", "target" = gene_list[["Anti_Inflam"]], "mor" = -1))
df_list <- lapply(names(gene_list), \(.){
    data.frame("source" = ., "target" = gene_list[[.]], "mor" = 1)
})
net2 <- do.call(rbind, df_list)

# net <- do.call(rbind,df_list)

res_mlm <- decoupleR::run_mlm(
    mat = pseudo_seurat[["RNA"]]$data,
    network = net,
    .source = "source",
    .target = "target",
    center = FALSE
)
res_mlm <- res_mlm |> left_join(check, by = join_by(condition == sample_name))
res_mlm_final <- res_mlm |> left_join(total_df, by = join_by(condition == sample_name))

infiltration_order <- res_mlm_final %>%
    filter(source == "True_Infiltration") %>%
    arrange(desc(score)) %>%
    pull(condition)
Inflammation_order <- res_mlm_final %>%
    filter(source == "True_Inflammation") %>%
    arrange(desc(score)) %>%
    pull(condition)
col <- c("Inflammatory_cells" = "Inflammatory", "Infiltration_cells" = "Infiltrating", "Ann_lvl_1H" = "Microglia", "Ann_lvl_2" = "Tregs", "Inflammation_score" = "Inflammation_score", "Infiltration_score" = "Infiltration_score")
order_list[[col["Inflammation_score"]]] <- order_list[[1]][match(Inflammation_order, gsub("_", "-", x = order_list[[1]]))]
order_list[[col["Infiltration_score"]]] <- order_list[[2]][match(infiltration_order, gsub("_", "-", x = order_list[[2]]))]
```

```{r}
p <- lapply(colnames(total_df)[-1], \(col){
    plot <- res_mlm_final %>% ggpubr::ggscatter(
        x = as.character(col), y = "score",
        add = "reg.line",
        add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line    conf.int = TRUE, # Add confidence interval
        cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
        conf.int = TRUE, # Add confidence interval
        cor.coeff.args = list(method = "pearson", label.sep = "\n")
    ) + x_axis_theme
    plot <- ggpubr::facet(plot,
        facet.by = c("source", "tumour_abbreviated"), scales = "free", short.panel.labs = T, # Allow long labels in panels
        panel.labs.background = list(fill = "grey", color = "grey"), panel.labs.font = list(size = 13, color = "black")
    )
    return(plot)
})
pdf(here("Glioma_Project/04_figs/03_significance_ratios_SUBtype.pdf"), width = 8, height = 15)
p
dev.off()


p2 <- lapply(colnames(total_df)[-1], \(col){
    plot <- res_mlm_final %>% ggpubr::ggscatter(
        x = as.character(col), y = "score",
        add = "reg.line",
        add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line    conf.int = TRUE, # Add confidence interval
        cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
        conf.int = TRUE, # Add confidence interval
        cor.coeff.args = list(method = "pearson")
    ) + x_axis_theme
    plot <- ggpubr::facet(plot,
        facet.by = c("source", "IDH_status"), scales = "free", short.panel.labs = TRUE, # Allow long labels in panels
        panel.labs.background = list(fill = "grey", color = "grey"), panel.labs.font = list(size = 13, color = "black")
    )
    return(plot)
})
pdf(here("Glioma_Project/04_figs/03_significance_ratios_IDH.pdf"), width = 8, height = 12)
p2
dev.off()

p_overview_IDH <- res_mlm_final %>% ggplot(mapping = aes(x = IDH_status, y = score)) +
    geom_boxplot() +
    facet_wrap(~source, nrow = 1, scales = "free_y") +
    ggpubr::stat_compare_means(comparisons = list(c("wild_type", "mutant")), label = "p.signif", method = "wilcox.test") +
    theme_bw() +
    x_axis_theme
p_overview_tumour <- res_mlm_final %>% ggplot(mapping = aes(x = tumour_abbreviated, y = score)) +
    geom_boxplot() +
    facet_wrap(~source, nrow = 1, scales = "free_y") +
    ggpubr::stat_compare_means(comparisons = list(c("ASTR", "GBM"), c("ASTR", "ODG"), c("GBM", "ODG")), label = "p.signif", method = "wilcox.test") +
    theme_bw() +
    x_axis_theme
pdf(here("Glioma_Project/04_figs/03_significance_testing_norm.pdf"), width = 9, height = 5)
p_overview_IDH
p_overview_tumour
dev.off()
```



```{r trying some statistical tests continous}
res_mlm_final$cells_nuclei <- NULL
res_mlm_final$pool_correct <- NULL
res_mlm_final$age_at_surgery <- NULL
res_mlm_final$age_at_surgery_correct <- as.numeric(res_mlm_final$age_at_surgery_correct)

# str(res_mlm_final)
columns_to_check <- unlist(lapply(colnames(res_mlm_final)[7:38], \(col){
    vec <- res_mlm_final[[col]]
    if (is.character(vec) && length(unique(vec) > 1)) {
        print(col)
    }
}))

columns_to_check <- columns_to_check[-which(columns_to_check == "cell_het_paper_id")]

# res_mlm_final$source_group <- paste0('source_',)

list_testing <- lapply(columns_to_check, \(col){
    result <- ggpubr::compare_means(as.formula(paste0("score ~ ", as.character(col))), res_mlm_final, group.by = "source")
    result$comparison <- as.character(col)
    return(result)
})

testing_object <- do.call(rbind, list_testing)
testing_object %>%
    as.data.frame() %>%
    filter(p.adj < 0.05) %>%
    gt::gt()

columns_to_check_continous <- unlist(lapply(colnames(res_mlm_final)[7:43], \(col){
    vec <- res_mlm_final[[col]]
    if (is.numeric(vec) && length(unique(vec) > 1)) {
        print(col)
    }
}))

res_mlm_final_c <- res_mlm_final
result_dfs <- lapply(columns_to_check_continous, \(col){
    result_list <- lapply(unique(res_mlm_final_c$source), \(group){
        data <- res_mlm_final_c[res_mlm_final_c$source == group, ]
        data <- data[!(data[[col]]) > 10000000, ] # Getting rid of inf`
        result <- lm(data = data, as.formula(paste0("score ~ ", as.character(col))))
        df <- data.frame(
            column = col,
            score = group,
            "R-squared" = summary(result)$r.squared,
            "p_value" = summary(result)$coefficients[2, 4]
        )
        return(df)
    })
    final_df <- do.call(rbind, result_list)
    return(final_df)
})
result_df <- do.call(rbind, result_dfs)
result_df %>%
    filter(R.squared > 0.4) %>%
    filter(p_value < 0.05)
```

```{r}
stats_df <- res_mlm_final %>%
    pivot_longer(
        cols = colnames(total_df)[-1],
        names_to = "variable",
        values_to = "value"
    ) %>%
    group_by(variable, source, IDH_status) %>%
    rstatix::cor_test(value, score, method = "pearson")


stats_df <- res_mlm_final %>%
    pivot_longer(
        cols = columns_to_check,
        names_to = "variable",
        values_to = "value"
    ) %>%
    group_by(variable, source) %>%
    rstatix::cor_test(value, score, method = "pearson")


stats_df <- res_mlm_final %>%
    pivot_longer(
        cols = columns_to_check_continous[-c(2:7)],
        names_to = "variable",
        values_to = "value"
    ) %>%
    group_by(variable, source, IDH_status) %>%
    rstatix::cor_test(value, score, method = "pearson")
remove <- res_mlm_final %>%
    group_by(!!sym("storage_condition")) %>%
    summarise(count = n()) %>%
    filter(count < 3) %>%
    pull(!!sym("storage_condition"))
data <- res_mlm_final[!(res_mlm_final[["storage_condition"]] %in% remove), ]
!(res_mlm_final[["storage_condition"]] %in% remove) %>% table()
res_mlm_final %>%
    stats_df() %>%
    as.data.frame() %>%
    filter(abs(cor) > 0.5) %>%
    filter(p < 0.05)

column <- "storage_condition"
remove <- res_mlm_final %>%
    group_by(!!sym(column)) %>%
    summarise(count = n()) %>%
    filter(count < 3) %>%
    pull(!!sym(column))
data <- res_mlm_final[!(res_mlm_final[[column]] %in% remove), ]
data$storage_condition %>% table()
df_list <- lapply(columns_to_check[-c(1, 5, 6, 10)], \(column){
    print(column)
    remove <- res_mlm_final %>%
        group_by(!!sym(column)) %>%
        summarise(count = n()) %>%
        filter(count < 6) %>%
        pull(!!sym(column))
    data <- res_mlm_final[!(res_mlm_final[[column]] %in% remove), ]
    data$condition <- paste0(data[[column]], "_", column)
    data %>%
        pivot_longer(
            cols = columns_to_check_continous[-c(2:7)],
            names_to = "variable",
            values_to = "value"
        ) %>%
        group_by(variable, source, condition) %>%
        rstatix::cor_test(value, score, method = "pearson")
})

do.call(rbind, df_list) %>%
    as.data.frame() %>%
    filter(abs(cor) > 0.5) %>%
    filter(p < 0.05) %>%
    group_by(source, condition) %>%
    gt::gt()
```


Which are to be investigated:
    1. Scores per tumour subtype correlated with DC_count_Microglia / Microglia_prop / Macro_mono_prop
    2. Tumour grade
```{r}
sessionInfo()
```

```{r,eval = F}
rmarkdown::render(here::here("Glioma_Project/Scripting/03-02-2026_testing.rmd"), output_dir = here::here("Glioma_Project/02_knits"), output_file = "Anno_investigations.html")
```